<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Assessment Form - Hartford Market (Supabase)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Injected Supabase credentials -->
    <script>
      window.__supabase_url = "https://bjexzkfrkkaemybwmahy.supabase.co";
      window.__supabase_anon_key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJqZXh6a2Zya2thZW15YndtYWh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3NzI3NTMsImV4cCI6MjA2NDM0ODc1M30.eN-7mg1h6G9j8WHUrNKTVnfMc0aUjkAtss0o646ZISQ";
    </script>

    <script type="module">
        // Supabase Client (assuming __supabase_url and __supabase_anon_key are globally available)
        const supabaseUrl = typeof __supabase_url !== 'undefined' ? __supabase_url : "YOUR_SUPABASE_URL";
        const supabaseAnonKey = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : "YOUR_SUPABASE_ANON_KEY";

        let supabase;
        try {
            supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
            console.log("Supabase client initialized.");
        } catch (e) {
            console.error("Error initializing Supabase client:", e);
            showModal("Initialization Error", "Could not initialize Supabase client. Backend features will be unavailable.", "error");
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tenant-assessment-app-supabase';
        let userId = null;
        let userEmail = null;

        // --- DOM Elements ---
        const form = document.getElementById('tenantAssessmentForm');
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const playBtn = document.getElementById('playBtn');
        const audioPlayer = document.getElementById('audioPlayer');
        const recordingStatusEl = document.getElementById('recordingStatus');
        const audioPlaybackEl = document.getElementById('audioPlayback');
        const reviewSection = document.getElementById('reviewSection');
        const reviewSummary = document.getElementById('reviewSummary');
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const propertySelect = document.getElementById('property'); // New
        const unitSelect = document.getElementById('unit');       // New
        const recommendationRadios = document.querySelectorAll('input[name="recommendation"]');
        const saveDraftButton = document.getElementById('saveDraftBtn');
        const submitButton = form?.querySelector('button[type="submit"]');

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let audioBlob = null; // Will hold the recorded audio
        let voiceNoteUrl = null; // Will hold the URL after upload

        // --- Authentication Handling (same as before) ---
        async function handleAuth() {
            if (!supabase) return;
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                const { data: sessionData, error: sessionError } = await supabase.auth.setSession({ access_token: __initial_auth_token });
                if (sessionError) console.error("Error setting session with token:", sessionError.message);
                else if (sessionData.user) { userId = sessionData.user.id; userEmail = sessionData.user.email; }
                else console.log("setSession did not return a user.");
            }
            const { data: { session: currentSession } } = await supabase.auth.getSession();
            if (currentSession?.user) {
                userId = currentSession.user.id; userEmail = currentSession.user.email;
                console.log("User already signed in:", userId);
                await loadProperties(); // Load properties first
                await loadDraft(); // Load draft which might set property/unit
                enableAuthenticatedFeatures();
            } else {
                console.log("No active Supabase session.");
                await loadProperties(); // Still load properties for non-authed users if desired
                disableAuthenticatedFeatures();
            }
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log("Supabase auth event:", event);
                if (event === "SIGNED_IN" || event === "TOKEN_REFRESHED" || event === "USER_UPDATED") {
                    if (session?.user) {
                        userId = session.user.id; userEmail = session.user.email;
                        console.log("User signed in/updated:", userId);
                        if (event === "SIGNED_IN") { await loadProperties(); await loadDraft(); }
                        enableAuthenticatedFeatures();
                    } else { userId = null; userEmail = null; disableAuthenticatedFeatures(); }
                } else if (event === "SIGNED_OUT") {
                    userId = null; userEmail = null; console.log("User signed out.");
                    form.reset(); setDefaultDateTime();
                    if (propertySelect) propertySelect.innerHTML = '<option value="">Select Property</option>'; // Clear and add default
                    if (unitSelect) unitSelect.innerHTML = '<option value="">Select Unit</option>'; // Clear and add default
                    await loadProperties(); // Reload properties for fresh state
                    disableAuthenticatedFeatures();
                }
            });
        }
        function enableAuthenticatedFeatures() {
            if (saveDraftButton) saveDraftButton.disabled = false;
            if (submitButton) submitButton.disabled = false;
            console.log('enableAuthenticatedFeatures: Save Draft and Submit buttons enabled');
        }
        function disableAuthenticatedFeatures(message = "Auth required.") {
            if (saveDraftButton) saveDraftButton.disabled = false;
            if (submitButton) submitButton.disabled = false;
            console.log('disableAuthenticatedFeatures: Save Draft and Submit buttons enabled (auth checks removed)');
            // Removed modal popup for authentication required
        }

        // --- Dynamic Dropdown Loading ---
        async function loadProperties() {
            if (!supabase || !propertySelect) return;
            propertySelect.innerHTML = '<option value="">Loading Properties...</option>'; // Loading state
            try {
                const { data: properties, error } = await supabase
                    .from('properties')
                    .select('id, property_name')
                    .order('property_name');
                if (error) throw error;

                propertySelect.innerHTML = '<option value="">Select Property</option>'; // Clear loading and add default
                properties.forEach(property => {
                    const option = document.createElement('option');
                    option.value = property.id;
                    option.textContent = property.property_name;
                    propertySelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading properties:", error);
                propertySelect.innerHTML = '<option value="">Error loading properties</option>';
                showModal("Data Error", "Could not load properties: " + error.message, "error");
            }
        }

        async function loadUnits(propertyId, selectedUnitId = null) {
            if (!supabase || !unitSelect || !propertyId) {
                 if(unitSelect) unitSelect.innerHTML = '<option value="">Select Unit</option>';
                return;
            }
            unitSelect.innerHTML = '<option value="">Loading Units...</option>'; // Loading state
            try {
                const { data: units, error } = await supabase
                    .from('units')
                    .select('id, unit_number')
                    .eq('property_id', propertyId)
                    .eq('status', 'available') // Only show available units
                    .order('unit_number');
                if (error) throw error;

                unitSelect.innerHTML = '<option value="">Select Unit</option>'; // Clear loading and add default
                units.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = unit.unit_number;
                    unitSelect.appendChild(option);
                });
                if (selectedUnitId) { // If loading from a draft, try to select the unit
                    unitSelect.value = selectedUnitId;
                }
            } catch (error) {
                console.error("Error loading units:", error);
                unitSelect.innerHTML = '<option value="">Error loading units</option>';
                showModal("Data Error", "Could not load units: " + error.message, "error");
            }
        }

        // Event listener for property selection
        propertySelect?.addEventListener('change', function() {
            if (this.value) {
                loadUnits(this.value);
            } else {
                unitSelect.innerHTML = '<option value="">Select Unit</option>'; // Reset units if no property selected
            }
        });


        // --- Voice Recording (same as before) ---
        async function startRecording() { /* ... same as before ... */
             if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { showModal("Error", "Media Devices API not supported."); return; }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream); audioChunks = []; audioBlob = null; voiceNoteUrl = null; // Reset
                mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlaybackEl.classList.remove('hidden'); playBtn.classList.remove('hidden'); playBtn.classList.add('inline-flex');
                };
                mediaRecorder.start(); isRecording = true;
                recordBtn.classList.add('hidden'); stopBtn.classList.remove('hidden'); stopBtn.classList.add('inline-flex');
                recordingStatusEl.classList.remove('hidden'); audioPlaybackEl.classList.add('hidden'); playBtn.classList.add('hidden');
            } catch (err) { console.error("Recording Error:", err); showModal("Mic Error", `No mic: ${err.message}.`, "error"); }
        }
        function stopRecording() { /* ... same as before ... */
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(track => track.stop()); isRecording = false;
                recordBtn.classList.remove('hidden'); recordBtn.classList.add('inline-flex');
                stopBtn.classList.add('hidden'); recordingStatusEl.classList.add('hidden');
            }
        }
        function playRecording() { /* ... same as before ... */
             if (audioPlayer.src && audioPlayer.src !== window.location.href) audioPlayer.play(); // check if src is not just base URL
             else showModal("Info", "No recording available to play or recording is empty.");
        }


        // --- Review Functionality (adjusted for new dropdowns) ---
        function showReview() {
            const formData = new FormData(form);
            const data = {};
            formData.forEach((value, key) => {
                if (form.elements[key]?.type === 'checkbox') {
                    if (!data[key]) data[key] = []; data[key].push(value);
                } else { data[key] = value; }
            });

            const propertyName = propertySelect.options[propertySelect.selectedIndex]?.text || data.property; // Use text for review
            const unitNumber = unitSelect.options[unitSelect.selectedIndex]?.text || data.unit; // Use text for review

            const getCheckboxLabels = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.nextElementSibling.textContent.trim());
            const positives = getCheckboxLabels("positive_observations");
            const negatives = getCheckboxLabels("concerning_signs");
            const housingInfo = getCheckboxLabels("housing_stability");
            const kidsPetsInfo = getCheckboxLabels("kids_assessment");
            const paymentInfo = getCheckboxLabels("payment_type_observations"); // Match sectionsData
            const localInfo = getCheckboxLabels("local_stability");
            const redFlags = getCheckboxLabels("red_flags_observations"); // Match sectionsData
            const assessmentInfo = getCheckboxLabels("assessment_scores");
            const recommendation = data.recommendation || 'Not selected';

            reviewSummary.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow"><h4 class="text-sm font-semibold text-gray-700 mb-2">Basic Info</h4><ul class="text-xs text-gray-600 space-y-1"><li><strong>Property:</strong> ${propertyName||'N/A'}</li><li><strong>Unit:</strong> ${unitNumber||'N/A'}</li><li><strong>Prospect:</strong> ${data.prospectName||'N/A'}</li><li><strong>Phone:</strong> ${data.prospectPhone||'N/A'}</li><li><strong>Email:</strong> ${data.prospectEmail||'N/A'}</li></ul></div>
                ${createReviewCategoryHTML("Positive Observations", positives)}
                ${createReviewCategoryHTML("Concerning Signs", negatives, '⚠️')}
                ${createReviewCategoryHTML("Housing Situation Notes", [data['housing_notes'] || "No notes"], '📝')}
                ${createReviewCategoryHTML("Housing Stability", housingInfo)}
                ${createReviewCategoryHTML("Kids/Pets Notes", [data['kids_pets_notes'] || "No notes"], '📝')}
                ${createReviewCategoryHTML("Kids Assessment", kidsPetsInfo)}
                ${createReviewCategoryHTML("Employment / Payment Details", [data['employment_details'] || "No notes"], '📝')}
                ${createReviewCategoryHTML("Payment Observations", paymentInfo)}
                ${createReviewCategoryHTML("Local Connections Notes", [data['local_connections_notes'] || "No notes"], '📝')}
                ${createReviewCategoryHTML("Local Stability", localInfo)}
                ${createReviewCategoryHTML("Red Flags", redFlags, '🚩')}
                ${createReviewCategoryHTML("General Assessment Scores", assessmentInfo)}
                ${createReviewCategoryHTML("Additional Notes", [data['additional_notes'] || "No notes"], '📝')}
                ${createReviewCategoryHTML("Maintenance Issues for Unit", [data['maintenance_issues'] || "No notes"], '🔧')}
                <div class="bg-white p-4 rounded-lg shadow md:col-span-2"><h4 class="text-sm font-semibold text-gray-700 mb-2">Final Recommendation</h4><p class="text-lg font-bold ${recommendation === 'approve' ? 'text-green-600' : recommendation === 'maybe' ? 'text-yellow-600' : recommendation === 'hell-no' ? 'text-red-600' : 'text-gray-600'}">${recommendation.toUpperCase()}</p></div>`;
            reviewSection.classList.remove('hidden');
            reviewSection.scrollIntoView({ behavior: 'smooth' });
        }
        function createReviewCategoryHTML(title, items, icon = '✓') { /* ... same as before ... */
            if (!items || items.length === 0 || (items.length === 1 && (items[0] === "No notes" || items[0] === ""))) { return `<div class="bg-white p-4 rounded-lg shadow"><h4 class="text-sm font-semibold text-gray-700 mb-2">${title}</h4><p class="text-xs text-gray-500 italic">None</p></div>`; }
            return `<div class="bg-white p-4 rounded-lg shadow"><h4 class="text-sm font-semibold text-gray-700 mb-2">${title} (${items.length})</h4><ul class="text-xs text-gray-600 space-y-1">${items.map(item => `<li>${icon} ${item}</li>`).join('')}</ul></div>`;
        }

        // Helper to get checked values for submission
        function getCheckedValues(name) {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
        }

        // --- Supabase Draft and Submission Handling ---
        async function saveDraft(showNotification = true) { /* ... same as before, using draftDataObject ... */
            console.log('saveDraft called');
            if (!supabase) { if(showNotification) showModal("Auth Error", "Supabase client not initialized."); return; }
            const formData = new FormData(form); const draftDataObject = {};
            formData.forEach((value, key) => {
                const element = form.elements[key];
                if (element?.type === 'checkbox') { if (!draftDataObject[key]) draftDataObject[key] = []; draftDataObject[key].push(value); }
                else if (element?.type === 'radio') { if (element.checked) draftDataObject[key] = value; }
                else { draftDataObject[key] = value; }
            });
            console.log('Draft data to save:', draftDataObject);
            const { error } = await supabase.from('tenant_assessment_drafts').upsert({ user_id: userId, app_id: appId, draft_data: draftDataObject, updated_at: new Date().toISOString() }, { onConflict: 'user_id, app_id' });
            if (error) { console.error("Save Draft Error:", error); if (showNotification) showModal("Save Error", `Draft not saved: ${error.message}`); }
            else { if (showNotification) showModal("Draft Saved", "Draft saved to Supabase.", "success"); console.log("Draft saved."); }
        }

        async function loadDraft() { /* ... adjusted for new dropdowns ... */
            if (!supabase || !userId) { setDefaultDateTime(); return; }
            const { data: loadedDraft, error } = await supabase.from('tenant_assessment_drafts').select('draft_data, updated_at').eq('user_id', userId).eq('app_id', appId).maybeSingle();
            if (error) { console.error("Load Draft Error:", error); setDefaultDateTime(); return; }

            if (loadedDraft && loadedDraft.draft_data) {
                const draftData = loadedDraft.draft_data;
                const tempPropertyId = draftData.property; // Store property from draft
                const tempUnitId = draftData.unit; // Store unit from draft

                Object.entries(draftData).forEach(([key, value]) => {
                    const fields = form.querySelectorAll(`[name="${key}"]`);
                    fields.forEach(field => {
                        if (field.tagName === 'SELECT' && field.id === 'property') {
                            // Property will be set after options are loaded
                        } else if (field.tagName === 'SELECT' && field.id === 'unit') {
                            // Unit will be set after options are loaded
                        } else if (field.type === 'checkbox') {
                            if (Array.isArray(value)) field.checked = value.includes(field.value); else field.checked = field.value === value;
                        } else if (field.type === 'radio') {
                            field.checked = field.value === value;
                        } else if (field.type === 'date' && typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}$/)) {
                             field.value = value;
                        } else if (field.type === 'time' && typeof value === 'string' && value.includes(':')) {
                            field.value = value;
                        } else { field.value = value; }
                    });
                });

                if (tempPropertyId && propertySelect) {
                    propertySelect.value = tempPropertyId; // Set property value
                    await loadUnits(tempPropertyId, tempUnitId); // Load units for this property and try to select the unit
                } else if (propertySelect) { // if no property in draft, ensure units dropdown is reset or reflects current state
                    if (propertySelect.value) await loadUnits(propertySelect.value);
                    else unitSelect.innerHTML = '<option value="">Select Unit</option>';
                }


                const currentRecommendation = draftData.recommendation;
                if (currentRecommendation) { const radioToCheck = form.querySelector(`input[name="recommendation"][value="${currentRecommendation}"]`); if (radioToCheck) { radioToCheck.checked = true; updateRecommendationVisuals(radioToCheck); } }
                showModal("Draft Loaded", `Draft from ${new Date(loadedDraft.updated_at).toLocaleString()} loaded.`, "info");
            } else { setDefaultDateTime(); }
        }
        async function deleteSupabaseDraft() { /* ... same as before ... */
             if (!supabase || !userId) return;
            const { error } = await supabase.from('tenant_assessment_drafts').delete().eq('user_id', userId).eq('app_id', appId);
            if (error) console.error("Delete Draft Error:", error.message); else console.log("Draft deleted.");
        }

        // --- Voice Note Upload (Placeholder) ---
        async function uploadVoiceNoteAndGetURL(blob) {
            if (!blob || !supabase || !userId) return null;
            const fileName = `voice-notes/${appId}/${userId}/${Date.now()}.webm`;
            try {
                showModal("Uploading...", "Voice note is being uploaded.", "info");
                const { data, error } = await supabase.storage.from('tenant-notes').upload(fileName, blob, {
                    cacheControl: '3600',
                    upsert: false
                });
                if (error) throw error;

                const { data: urlData } = supabase.storage.from('tenant-notes').getPublicUrl(fileName);
                showModal("Upload Complete", "Voice note uploaded!", "success");
                console.log("Voice note uploaded:", urlData.publicUrl);
                return urlData.publicUrl;
            } catch (error) {
                console.error('Error uploading voice note:', error);
                showModal("Upload Failed", `Could not upload voice note: ${error.message}`, "error");
                return null;
            }
        }


        async function submitAssessmentData(event) { // Renamed from submitAssessment to avoid conflict with user-provided function name
            event.preventDefault();
            console.log('submitAssessmentData called');
            if (!supabase) { console.log('Supabase client not initialized'); showModal("Error", "Supabase client not initialized.", "error"); return; }
            // Remove userId check to allow public submission
            // if (!supabase || !userId) { showModal("Auth Error", "Must be signed in to submit."); return; }

            // Upload voice note if present
            if (audioBlob) {
                console.log('Uploading voice note...');
                voiceNoteUrl = await uploadVoiceNoteAndGetURL(audioBlob);
            }

            const currentFormData = new FormData(form); // Use current form data directly
            console.log('Form data collected:', Object.fromEntries(currentFormData.entries()));

            try {
                // 1. Create or update prospect record
                const prospectData = {
                    name: currentFormData.get('prospectName'),
                    phone: currentFormData.get('prospectPhone'),
                    email: currentFormData.get('prospectEmail'),
                    payment_method: getCheckedValues('payment_type_observations')[0] || null,
                    employment_status: currentFormData.get('work-details') ? 'Employed' : null,
                    notes: currentFormData.get('additional_notes'),
                    status: currentFormData.get('recommendation') === 'approve' ? 'qualified' : 'new'
                };
                console.log("Upserting Prospect:", prospectData);
                const { data: prospect, error: prospectError } = await supabase
                    .from('prospects')
                    .upsert(prospectData, { onConflict: 'phone' })
                    .select()
                    .single();
                if (prospectError) throw prospectError;
                console.log("Prospect upserted:", prospect);

                // 2. Create assessment record
                const assessmentData = {
                    prospect_id: prospect.id,
                    property_id: currentFormData.get('property'),
                    unit_id: currentFormData.get('unit'),
                    agent_name: currentFormData.get('agent'),
                    showing_date: currentFormData.get('date'),
                    showing_time: currentFormData.get('time'),
                    positive_observations: getCheckedValues('positive_observations'),
                    concerning_signs: getCheckedValues('concerning_signs'),
                    housing_notes: currentFormData.get('housing_notes'),
                    housing_stability: getCheckedValues('housing_stability'),
                    kids_pets_notes: currentFormData.get('kids_pets_notes'),
                    kids_assessment: getCheckedValues('kids_assessment'),
                    payment_type: getCheckedValues('payment_type_observations')[0] || null,
                    employment_details: currentFormData.get('work-details'),
                    local_connections_notes: currentFormData.get('local_notes'),
                    local_stability: getCheckedValues('local_stability'),
                    red_flags: getCheckedValues('red_flags_observations'),
                    assessment_scores: getCheckedValues('assessment_scores'),
                    additional_notes: currentFormData.get('additional_notes'),
                    voice_note_url: voiceNoteUrl,
                    maintenance_issues: currentFormData.get('maintenance_issues'),
                    recommendation: currentFormData.get('recommendation')
                };
                console.log("Inserting Assessment:", assessmentData);
                const { data: assessment, error: assessmentError } = await supabase
                    .from('tenant_assessments')
                    .insert(assessmentData)
                    .select()
                    .single();
                if (assessmentError) throw assessmentError;
                console.log("Assessment inserted:", assessment);

                // 3. Send email notification
                await sendEmailNotification(assessment.id);

                showModal("Assessment Submitted", "Your assessment has been successfully submitted!", "success");
                await deleteSupabaseDraft();
                form.reset(); setDefaultDateTime();
                if (propertySelect) propertySelect.value = ''; // Reset dropdown
                if (unitSelect) unitSelect.innerHTML = '<option value="">Select Unit</option>'; // Reset dropdown
                audioPlaybackEl.classList.add('hidden'); audioPlayer.src = ''; audioBlob = null; voiceNoteUrl = null;
                // Reset recommendation visuals
                recommendationRadios.forEach(radio => { /* ... same reset logic ... */ });
            } catch (error) {
                console.error('Error submitting assessment:', error);
                showModal("Submission Error", `Could not submit: ${error.message}`, "error");
            }
        }
        form?.addEventListener('submit', submitAssessmentData); // Attach the renamed handler

        // --- Email Notification Logic ---
        async function sendEmailNotification(assessmentId) {
            if (!supabase) { console.error("Supabase client not ready for email."); return; }
            try {
                const { data: assessment, error: fetchError } = await supabase
                    .from('tenant_assessments')
                    .select(`
                        *,
                        prospects (id, name, phone, email),
                        properties (id, property_name),
                        units (id, unit_number)
                    `)
                    .eq('id', assessmentId)
                    .single();

                if (fetchError) throw fetchError;
                if (!assessment) throw new Error("Assessment data not found for email.");
                if (!assessment.prospects) throw new Error("Prospect data missing for email.");
                if (!assessment.properties) throw new Error("Property data missing for email.");
                if (!assessment.units) throw new Error("Unit data missing for email.");


                const emailContentHTML = generateEmailTemplate(assessment);
                const emailData = {
                    to: 'leasing@stantoncap.com', // Hardcoded as per instructions
                    subject: `New Tenant Assessment - ${assessment.prospects.name} - ${assessment.recommendation.toUpperCase()}`,
                    html: emailContentHTML
                };

                // THIS IS WHERE YOU CALL YOUR BACKEND API for sending email
                // Example: fetch('/api/send-email', { method: 'POST', ... })
                // For now, we simulate and log to `email_notifications`
                console.log("Prepared email data:", emailData);
                showModal("Email Prep", "Email content generated. Sending via backend API is required.", "info");

                // Simulate logging to email_notifications
                // In a real scenario, the backend '/api/send-email' would do this after attempting to send.
                const notificationLog = {
                    assessment_id: assessmentId,
                    recipient_email: emailData.to,
                    subject: emailData.subject,
                    status: 'pending_backend', // Indicates client prepared, backend needs to send
                    sent_at: null, // Will be set by backend
                    error_message: "Awaiting backend email dispatch"
                };
                const { error: logError } = await supabase.from('email_notifications').insert(notificationLog);
                if (logError) console.error("Error logging email notification (client-side):", logError);

            } catch (error) {
                console.error('Error preparing/logging email notification:', error);
                // Log failed email attempt (client-side if backend call isn't even reached)
                await supabase.from('email_notifications').insert({
                    assessment_id: assessmentId, recipient_email: 'leasing@stantoncap.com',
                    subject: 'Failed to generate email content', status: 'failed',
                    error_message: error.message
                }).catch(e => console.error("Double fault logging email failure:", e));
                 showModal("Email Error", `Could not prepare email: ${error.message}`, "error");
            }
        }

        function generateEmailTemplate(assessment) {
            const recommendation = assessment.recommendation.toUpperCase();
            // Handle HELL_NO specifically for the email template key
            const displayRecommendation = recommendation === "HELL-NO" ? "HELL_NO" : recommendation;
            const recommendationColor = {
                'APPROVE': '#059669', 'MAYBE': '#d97706', 'HELL_NO': '#dc2626'
            }[displayRecommendation] || '#6b7280';

            // Helper to format array data for email
            const formatArrayForEmail = (arr) => arr && arr.length > 0 ? `<ul>${arr.map(item => `<li>${item}</li>`).join('')}</ul>` : '<p>None</p>';

            return `
                <html><body style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #eee; line-height: 1.6;">
                    <h2 style="color: #1f2937; text-align: center;">Tenant Assessment Summary</h2>
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin-top: 0; color: #334155; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Applicant & Property</h3>
                        <p><strong>Prospect:</strong> ${assessment.prospects.name || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${assessment.prospects.phone || 'N/A'}</p>
                        <p><strong>Email:</strong> ${assessment.prospects.email || 'N/A'}</p>
                        <p><strong>Property:</strong> ${assessment.properties.property_name || 'N/A'}</p>
                        <p><strong>Unit:</strong> ${assessment.units.unit_number || 'N/A'}</p>
                        <p><strong>Agent:</strong> ${assessment.agent_name || 'N/A'}</p>
                        <p><strong>Showing:</strong> ${assessment.showing_date} at ${assessment.showing_time}</p>
                    </div>
                    <div style="background: ${recommendationColor}; color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; font-size: 1.5em;">FINAL RECOMMENDATION: ${recommendation}</h2>
                    </div>
                    ${assessment.positive_observations && assessment.positive_observations.length > 0 ? `<details open style="margin-bottom:15px; padding:10px; background:#e0f2fe; border-radius:5px;"><summary style="font-weight:bold; color:#0c4a6e; cursor:pointer;">Positive Observations (${assessment.positive_observations.length})</summary>${formatArrayForEmail(assessment.positive_observations)}</details>` : ''}
                    ${assessment.concerning_signs && assessment.concerning_signs.length > 0 ? `<details open style="margin-bottom:15px; padding:10px; background:#ffe4e6; border-radius:5px;"><summary style="font-weight:bold; color:#b91c1c; cursor:pointer;">Concerning Signs (${assessment.concerning_signs.length})</summary>${formatArrayForEmail(assessment.concerning_signs)}</details>` : ''}
                    ${assessment.red_flags && assessment.red_flags.length > 0 ? `<details open style="margin-bottom:15px; padding:10px; background:#fee2e2; border-radius:5px;"><summary style="font-weight:bold; color:#ef4444; cursor:pointer;">Red Flags (${assessment.red_flags.length})</summary>${formatArrayForEmail(assessment.red_flags)}</details>` : ''}
                    <h3 style="color: #334155; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">Detailed Notes</h3>
                    <p><strong>Housing Notes:</strong> ${assessment.housing_notes || 'N/A'}</p>
                    <p><strong>Kids/Pets Notes:</strong> ${assessment.kids_pets_notes || 'N/A'}</p>
                    <p><strong>Employment/Payment Details:</strong> ${assessment.employment_details || 'N/A'}</p>
                    <p><strong>Local Connections Notes:</strong> ${assessment.local_connections_notes || 'N/A'}</p>
                    ${assessment.maintenance_issues ? `<div style="background: #fef9c3; padding: 10px; border-radius: 5px; margin:15px 0; border:1px solid #fde68a;"><h4 style="color: #854d0e; margin-top: 0;">Maintenance Issues Noted:</h4><p style="margin-bottom:0;">${assessment.maintenance_issues}</p></div>` : ''}
                    ${assessment.additional_notes ? `<div style="background: #f3f4f6; padding: 10px; border-radius: 5px; margin:15px 0; border:1px solid #e5e7eb;"><h4 style="color: #4b5563; margin-top: 0;">Additional General Notes:</h4><p style="margin-bottom:0;">${assessment.additional_notes}</p></div>` : ''}
                    ${assessment.voice_note_url ? `<p><strong>Voice Note:</strong> <a href="${assessment.voice_note_url}">Listen here</a></p>` : ''}
                    <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #e5e7eb; font-size: 0.8em; color: #6b7280; text-align:center;">
                        Assessment ID: ${assessment.id}<br>Submitted on ${new Date(assessment.created_at).toLocaleString()}
                    </div>
                </body></html>
            `;
        }


        function setDefaultDateTime() {
            if (dateInput) {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                dateInput.value = today;
            }
            if (timeInput) {
                const now = new Date();
                // Format as HH:MM (24-hour)
                const hh = String(now.getHours()).padStart(2, '0');
                const mm = String(now.getMinutes()).padStart(2, '0');
                timeInput.value = `${hh}:${mm}`;
            }
        }
        function showModal(title, message, type = "info") { /* ... same as before ... */
            const modal = document.getElementById('notificationModal'), modalTitle = document.getElementById('modalTitle'), modalMessage = document.getElementById('modalMessage'), modalContent = document.getElementById('modalContent');
            modalTitle.textContent = title; modalMessage.textContent = message;
            modalContent.className = 'p-6 rounded-lg shadow-xl max-w-md w-full border-l-4'; modalTitle.className = 'font-bold text-lg mb-1';
            if (type === "success") { modalContent.classList.add('bg-green-100','border-green-500','text-green-700'); modalTitle.classList.add('text-green-800'); }
            else if (type === "error") { modalContent.classList.add('bg-red-100','border-red-500','text-red-700'); modalTitle.classList.add('text-red-800'); }
            else { modalContent.classList.add('bg-blue-100','border-blue-500','text-blue-700'); modalTitle.classList.add('text-blue-800'); }
            modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 5000);
        }
        document.getElementById('closeModalBtn').addEventListener('click', () => { document.getElementById('notificationModal').classList.add('hidden'); document.getElementById('notificationModal').classList.remove('flex');});

        recordBtn?.addEventListener('click', startRecording);
        stopBtn?.addEventListener('click', stopRecording);
        playBtn?.addEventListener('click', playRecording);
        // Submit listener is now attached to `submitAssessmentData`
        document.getElementById('reviewBtn')?.addEventListener('click', showReview);
        saveDraftButton?.addEventListener('click', () => saveDraft(true));
        let autoSaveTimeout;
        form?.addEventListener('input', () => { clearTimeout(autoSaveTimeout); autoSaveTimeout = setTimeout(() => { if (userId) saveDraft(false); }, 3000); });
        function updateRecommendationVisuals(selectedRadio) { /* ... same as before ... */
            recommendationRadios.forEach(radio => { const D=radio.closest('.bottom-line-option'); D.classList.remove('ring-2','ring-offset-2','scale-105','shadow-lg','approve-selected','maybe-selected','no-selected','ring-green-500','ring-yellow-500','ring-red-500'); D.classList.add('hover:shadow-md');});
            if(selectedRadio.checked){const S=selectedRadio.closest('.bottom-line-option');S.classList.add('ring-2','ring-offset-2','scale-105','shadow-lg');S.classList.remove('hover:shadow-md');if(selectedRadio.value==="approve")S.classList.add('approve-selected','ring-green-500');else if(selectedRadio.value==="maybe")S.classList.add('maybe-selected','ring-yellow-500');else if(selectedRadio.value==="hell-no")S.classList.add('no-selected','ring-red-500');}
        }
        recommendationRadios.forEach(radio => radio.addEventListener('change', function() { updateRecommendationVisuals(this); }));

        window.addEventListener('load', async () => { if (supabase) { await handleAuth(); } else { setDefaultDateTime(); disableAuthenticatedFeatures();}});
        window.onerror = (msg, src, ln, col, err) => { console.error("Global Error:", msg, src, ln, err); showModal("App Error", "Unexpected error.", "error"); return true; };
        window.onunhandledrejection = e => { console.error("Unhandled Rejection:", e.reason); showModal("App Error", "Unhandled promise rejection.", "error"); };

        // --- Dynamic Section Rendering ---
        // IMPORTANT: Update namePrefix to match the database schema / getCheckedValues expectations
        const sectionsData = [
            { id: 'quick-observations', title: 'Quick Observations', icon: '🧐', subtitle: 'Initial impressions.', namePrefix: 'positive_observations', checkboxes: [ { id: 'arrived-responsibly', value: 'Arrived responsibly', label: 'Arrived responsibly (own car, family dropped off)' }, { id: 'appropriate-people', value: 'Came with appropriate people', label: 'Came with appropriate people' }, /* ... more ... */ { id: 'asked-questions', value: 'Asked good questions', label: 'Asked good questions about the place'}] },
            { id: 'concerning-signs', title: 'Concerning Signs', icon: '⚠️', subtitle: 'Immediate red flags.', namePrefix: 'concerning_signs', checkboxes: [ { id: 'sketchy-arrival', value: 'Sketchy arrival', label: 'Sketchy arrival' }, /* ... more ... */ { id: 'impaired', value: 'Seemed impaired', label: 'Seemed impaired or fidgety'}] },
            { id: 'housing-situation', title: 'Housing Situation', icon: '🏠', subtitle: 'Current living arrangements.', namePrefix: 'housing_stability', checkboxes: [ { id: 'stable-housing', value: 'Stable current housing', label: 'Stable current housing, planning ahead' }, { id: 'reasonable-move', value: 'Reasonable explanation for move', label: 'Reasonable explanation for moving' }, {id: 'normal-landlord', value: 'Normal landlord relations', label: 'Speaks normally about current landlord' }], notes: { id: 'housing_notes', placeholder: 'Their responses and impressions...', leadingQuestions: `"Where living now?" "Lease end?" "Landlord relationship?"`} },
            { id: 'kids-pets', title: 'Kids & Pets', icon: '🧸🐾', subtitle: 'Children or animals.', namePrefix: 'kids_assessment', checkboxes: [ { id: 'well-behaved-kids', value: 'Well-behaved kids', label: 'Kids well-behaved (if present)' }, { id: 'appropriate-size-occ', value: 'Appropriate occupants', label: 'Appropriate # occupants for unit' }], notes: { id: 'kids_pets_notes', placeholder: 'Number, ages, behavior, pets type/size...', leadingQuestions: `"Any children?" "Any pets?"`} },
            { id: 'payment-method', title: 'Payment & Employment', icon: '💳💼', subtitle: 'Rent payment plans & employment.', namePrefix: 'payment_type_observations', checkboxes: [ { id: 'section8-obs', value: 'Section 8 / Voucher', label: 'Section 8 / Housing Voucher' }, { id: 'private-pay-obs', value: 'Private pay', label: 'Private pay' }, { id: 'employed-obs', value: 'Currently employed', label: 'Currently employed' }], notes: { id: 'employment_details', placeholder: 'Work type, employer, stability, income...', leadingQuestions: `"How cover rent?" "Working? Where?" "Voucher?"`} },
            { id: 'local-connections', title: 'Local Connections', icon: '🔗🗺️', subtitle: 'Ties to local area.', namePrefix: 'local_stability', checkboxes: [ { id: 'local-family-support', value: 'Local family/support', label: 'Has local family/support' }, { id: 'established-area-conn', value: 'Established in area', label: 'Established in area' }], notes: { id: 'local_connections_notes', placeholder: 'Family, time in area, reasons for location...', leadingQuestions: `"Family in area?" "How long around?" "Why this area?"`} },
            { id: 'red-flags-detailed', title: 'Deeper Red Flags', icon: '🚩🚩', subtitle: 'Subtle warning signs.', namePrefix: 'red_flags_observations', checkboxes: [ { id: 'badmouth-landlord-flag', value: 'Badmouths landlord', label: 'Badmouths landlord (victim language)' }, {id: 'vague-history-flag', value: 'Vague history', label: 'Vague about housing/employment history'}, {id: 'desperate-timeline-flag', value: 'Desperate timeline', label: 'Desperate timeline (getting kicked out)'} ] },
            { id: 'overall-assessment', title: 'Overall Agent Assessment', icon: '⚖️👍👎', subtitle: 'Gut feeling & judgment.', namePrefix: 'assessment_scores', checkboxes: [ { id: 'good-neighbor-score', value: 'Good neighbor potential', label: 'Would be good neighbor' }, {id: 'care-property-score', value: 'Would care for property', label: 'Would take care of property'} ] },
            { id: 'additional-notes-section', title: 'General Additional Notes', icon: '✍️', subtitle: 'Other important details.', notes: { id: 'additional_notes', placeholder: 'Other crucial observations...', fullWidth: true } },
            { id: 'maintenance-issues-section', title: 'Maintenance Issues for Unit', icon: '🔧', subtitle: 'Log unit issues.', notes: { id: 'maintenance_issues', placeholder: 'Leaky faucet, broken tile...', fullWidth: true } }
        ];

        const dynamicSectionsContainer = document.getElementById('dynamicSectionsContainer');
        const sectionTpl = document.getElementById('checkbox-section-template').innerHTML;
        const checkboxTpl = document.getElementById('checkbox-item-template').innerHTML;
        const notesTpl = document.getElementById('notes-area-template').innerHTML;
        sectionsData.forEach(section => {
            let checkboxesHTML = ''; if (section.checkboxes) { section.checkboxes.forEach(cb => { checkboxesHTML += checkboxTpl.replace(/{ID}/g, cb.id).replace(/{NAME}/g, section.namePrefix).replace(/{VALUE}/g, cb.value).replace(/{LABEL}/g, cb.label); }); }
            let notesHTML = ''; if (section.notes) { notesHTML = notesTpl.replace(/{NOTES_ID}/g, section.notes.id).replace(/{PLACEHOLDER}/g, section.notes.placeholder).replace(/{LEADING_QUESTIONS}/g, section.notes.leadingQuestions || "").replace(/{FULL_WIDTH_CLASS}/g, section.notes.fullWidth ? 'md:col-span-full' : '');}
            const sectionHTML = sectionTpl.replace(/{ICON}/g, section.icon).replace(/{TITLE}/g, section.title).replace(/{SUBTITLE}/g, section.subtitle).replace('{CHECKBOXES}', checkboxesHTML).replace('{NOTES_AREA}', notesHTML);
            dynamicSectionsContainer.innerHTML += sectionHTML;
        });

        // Always enable Save Draft and Submit buttons for all users
        if (saveDraftButton) saveDraftButton.disabled = false;
        if (submitButton) submitButton.disabled = false;
    </script>
     <style> /* ... Same styles as before ... */ </style>
</head>
<body class="bg-slate-100 text-slate-800 antialiased">
    <!-- Notification Modal (same structure) -->
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm hidden items-center justify-center p-4 z-50"> <div id="modalContent" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-6 rounded-lg shadow-xl max-w-md w-full" role="alert"> <div class="flex"> <div class="py-1"></div> <div> <p id="modalTitle" class="font-bold text-lg mb-1">Notification</p> <p id="modalMessage" class="text-sm">Something happened.</p> </div> <button id="closeModalBtn" class="ml-auto -mx-1.5 -my-1.5 bg-transparent text-inherit rounded-lg focus:ring-2 focus:ring-blue-400 p-1.5 hover:bg-blue-200 inline-flex h-8 w-8" aria-label="Close"> <span class="sr-only">Close</span> <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg> </button> </div> </div> </div>

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        <header class="mb-8 p-6 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center">Tenant Assessment Form</h1>
            <p class="text-center text-blue-100 mt-1">Hartford Market - Quick Assessment Guide</p>
        </header>

        <form id="tenantAssessmentForm" class="space-y-8">
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold text-slate-700 mb-6 border-b pb-3">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div><label for="date" class="block text-sm font-medium text-slate-600 mb-1 required-ast">Date</label><input type="date" id="date" name="date" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                    <div><label for="time" class="block text-sm font-medium text-slate-600 mb-1 required-ast">Time</label><input type="time" id="time" name="time" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>

                    <!-- Property Dropdown -->
                    <div>
                        <label for="property" class="block text-sm font-medium text-slate-600 mb-1 required-ast">Property</label>
                        <select id="property" name="property" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white">
                            <option value="">Select Property</option>
                        </select>
                    </div>
                    <!-- Unit Dropdown -->
                    <div>
                        <label for="unit" class="block text-sm font-medium text-slate-600 mb-1 required-ast">Unit</label>
                        <select id="unit" name="unit" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 bg-white">
                            <option value="">Select Unit</option>
                        </select>
                    </div>

                    <div><label for="agent" class="block text-sm font-medium text-slate-600 mb-1 required-ast">Agent Name</label><input type="text" id="agent" name="agent" placeholder="Your Name" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                    <div><label for="prospectName" class="block text-sm font-medium text-slate-600 mb-1 required-ast">Prospect Name</label><input type="text" id="prospectName" name="prospectName" placeholder="Prospect's Full Name" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                    <div><label for="prospectPhone" class="block text-sm font-medium text-slate-600 mb-1 required-ast">Phone Number</label><input type="tel" id="prospectPhone" name="prospectPhone" placeholder="(555) 123-4567" required class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                    <div><label for="prospectEmail" class="block text-sm font-medium text-slate-600 mb-1">Email Address</label><input type="email" id="prospectEmail" name="prospectEmail" placeholder="email@example.com" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></div>
                </div>
            </section>

            <script id="checkbox-section-template" type="text/template"> <section class="bg-white p-6 rounded-xl shadow-lg"><h2 class="text-xl font-semibold text-slate-700 mb-1 border-b pb-3 flex items-center"><span class="mr-2">{ICON}</span>{TITLE}</h2><p class="text-xs text-slate-500 mb-4 italic">{SUBTITLE}</p><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">{CHECKBOXES}</div>{NOTES_AREA}</section></script>
            <script id="checkbox-item-template" type="text/template"><div class="flex items-start p-3 bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors duration-150"><input type="checkbox" id="{ID}" name="{NAME}" value="{VALUE}" class="h-5 w-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 mt-0.5 cursor-pointer"><label for="{ID}" class="ml-3 text-sm text-slate-700 cursor-pointer">{LABEL}</label></div></script>
            <script id="notes-area-template" type="text/template"><div class="mt-6 {FULL_WIDTH_CLASS}"><div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3 {HIDE_LEADING_QUESTIONS_CLASS}"><h4 class="text-xs font-semibold text-blue-700">Leading Questions:</h4><p class="text-xs text-blue-600 italic">{LEADING_QUESTIONS}</p></div><label for="{NOTES_ID}" class="block text-sm font-medium text-slate-600 mb-1">Notes:</label><textarea id="{NOTES_ID}" name="{NOTES_ID}" rows="3" placeholder="{PLACEHOLDER}" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"></textarea></div></script>

            <div id="dynamicSectionsContainer" class="space-y-8"></div>

            <!-- Voice Note, Bottom Line, Review, Action Buttons (same structure as before) -->
             <section class="bg-white p-6 rounded-xl shadow-lg"> <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b pb-3 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>Voice Note (Optional)</h2> <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center"><p class="text-sm text-green-700 mb-4">Record a quick voice note...</p><div id="voiceControlsContainer" class="flex flex-col sm:flex-row items-center justify-center gap-3"><button type="button" id="recordBtn" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" /></svg>Start Recording</button><button type="button" id="stopBtn" class="w-full sm:w-auto hidden items-center justify-center px-6 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition duration-150"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>Stop Recording</button><button type="button" id="playBtn" class="w-full sm:w-auto hidden items-center justify-center px-6 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>Play</button></div><p id="recordingStatus" class="text-sm text-red-600 font-semibold mt-3 hidden">🔴 Recording...</p><div id="audioPlayback" class="mt-4 hidden"><audio controls id="audioPlayer" class="w-full"></audio></div></div> </section>
             <section class="bg-white p-6 rounded-xl shadow-lg"> <h2 class="text-xl font-semibold text-slate-700 mb-6 border-b pb-3 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Bottom Line Recommendation</h2> <div class="bg-yellow-50 border-2 border-dashed border-yellow-300 rounded-lg p-6 text-center"><h3 class="text-lg font-medium text-yellow-800 mb-4">What's your final call?</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div class="bottom-line-option relative p-1 bg-green-50 border-2 border-green-200 rounded-xl hover:shadow-md hover:border-green-400 transition-all duration-200"><input type="radio" id="approve" name="recommendation" value="approve" class="sr-only"><label for="approve" class="block cursor-pointer p-4 rounded-lg"><span class="custom-radio-indicator"></span><span class="block text-lg font-semibold text-green-700">APPROVE</span><span class="block text-xs text-green-600 mt-1">Looks good!</span></label></div><div class="bottom-line-option relative p-1 bg-yellow-50 border-2 border-yellow-200 rounded-xl hover:shadow-md hover:border-yellow-400 transition-all duration-200"><input type="radio" id="maybe" name="recommendation" value="maybe" class="sr-only"><label for="maybe" class="block cursor-pointer p-4 rounded-lg"><span class="custom-radio-indicator"></span><span class="block text-lg font-semibold text-yellow-700">MAYBE</span><span class="block text-xs text-yellow-600 mt-1">Proceed with caution.</span></label></div><div class="bottom-line-option relative p-1 bg-red-50 border-2 border-red-200 rounded-xl hover:shadow-md hover:border-red-400 transition-all duration-200"><input type="radio" id="hell-no" name="recommendation" value="hell-no" class="sr-only"><label for="hell-no" class="block cursor-pointer p-4 rounded-lg"><span class="custom-radio-indicator"></span><span class="block text-lg font-semibold text-red-700">HELL NO</span><span class="block text-xs text-red-600 mt-1">Significant concerns.</span></label></div></div></div> </section>
             <section id="reviewSection" class="bg-slate-50 p-6 rounded-xl shadow-inner hidden"> <h3 class="text-2xl font-semibold text-slate-700 mb-6 pb-3 border-b">Review Your Assessment</h3><div id="reviewSummary" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div> </section>
             <div class="mt-10 pt-6 border-t border-slate-200 flex flex-col sm:flex-row sm:justify-end sm:items-center gap-3"> <button type="button" id="reviewBtn" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 border border-slate-300 text-sm font-medium rounded-lg shadow-sm text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>Review</button> <button type="button" id="saveDraftBtn" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 transition duration-150" disabled><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>Save Draft</button> <button type="submit" class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150" disabled><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Submit Assessment</button> </div>
        </form>
    </div>
</body>
</html>

